/*
 * CROPPIC
 * dependancy: jQuery
 * author: Ognjen "Zmaj Džedaj" Božičković and Mat Steinlin
 */
var $c=jQuery.noConflict();!function(o,t){Croppic=function(o,t){for(i in this.id=o,this.obj=$c("#"+o),this.outputDiv=this.obj,this.options={uploadUrl:"",uploadData:{},cropUrl:"",cropData:{},outputUrlId:"",imgEyecandy:!0,imgEyecandyOpacity:.2,zoomFactor:10,rotateFactor:5,doubleZoomControls:!0,rotateControls:!0,modal:!1,customUploadButtonId:"",loaderHtml:"",scaleToFill:!0,processInline:!1,loadPicture:"",onReset:null,enableMousescroll:!1,onBeforeImgUpload:null,onAfterImgUpload:null,onImgDrag:null,onImgZoom:null,onImgRotate:null,onBeforeImgCrop:null,onAfterImgCrop:null,onBeforeRemoveCroppedImg:null,onAfterRemoveCroppedImg:null,onError:null},t)this.options[i]=t[i];this.init()},Croppic.prototype={id:"",imgInitW:0,imgInitH:0,imgW:0,imgH:0,objW:0,objH:0,actualRotation:0,windowW:0,windowH:$c(o).height(),obj:{},outputDiv:{},outputUrlObj:{},img:{},defaultImg:{},croppedImg:{},imgEyecandy:{},form:{},iframeform:{},iframeobj:{},cropControlsUpload:{},cropControlsCrop:{},cropControlZoomMuchIn:{},cropControlZoomMuchOut:{},cropControlZoomIn:{},cropControlZoomOut:{},cropControlCrop:{},cropControlReset:{},cropControlRemoveCroppedImage:{},modal:{},loader:{},init:function(){this.objW=this.obj.width(),this.objH=this.obj.height(),this.actualRotation=0,$c.isEmptyObject(this.defaultImg)&&(this.defaultImg=this.obj.find("img")),this.createImgUploadControls(),$c.isEmptyObject(this.options.loadPicture)?this.bindImgUploadControl():this.loadExistingImage()},createImgUploadControls:function(){var o="";""===this.options.customUploadButtonId&&(o='<i class="cropControlUpload"></i>');var t='<i class="cropControlRemoveCroppedImage"></i>';$c.isEmptyObject(this.croppedImg)&&(t=""),$c.isEmptyObject(this.options.loadPicture)||(o="");var i='<div class="cropControls cropControlsUpload"> '+o+t+" </div>";this.outputDiv.append(i),this.cropControlsUpload=this.outputDiv.find(".cropControlsUpload"),""===this.options.customUploadButtonId?this.imgUploadControl=this.outputDiv.find(".cropControlUpload"):(this.imgUploadControl=$c("#"+this.options.customUploadButtonId),this.imgUploadControl.show()),$c.isEmptyObject(this.croppedImg)||(this.cropControlRemoveCroppedImage=this.outputDiv.find(".cropControlRemoveCroppedImage"))},bindImgUploadControl:function(){var o=this,i='<form class="'+o.id+'_imgUploadForm" style="visibility: hidden;">  <input type="file" name="img" id="'+o.id+'_imgUploadField">  </form>';o.outputDiv.append(i),o.form=o.outputDiv.find("."+o.id+"_imgUploadForm");var e=o.CreateFallbackIframe();o.imgUploadControl.off("click"),o.imgUploadControl.on("click",(function(){""===e?o.form.find('input[type="file"]').trigger("click"):o.iframeform.find('input[type="file"]').trigger("click")})),$c.isEmptyObject(o.croppedImg)||o.cropControlRemoveCroppedImage.on("click",(function(){typeof o.options.onBeforeRemoveCroppedImg==typeof Function&&o.options.onBeforeRemoveCroppedImg.call(o),o.croppedImg.remove(),o.croppedImg={},$c(this).hide(),typeof o.options.onAfterRemoveCroppedImg==typeof Function&&o.options.onAfterRemoveCroppedImg.call(o),$c.isEmptyObject(o.defaultImg)||o.obj.append(o.defaultImg),""!==o.options.outputUrlId&&$c("#"+o.options.outputUrlId).val("")})),o.form.find('input[type="file"]').change((function(){if(o.options.onBeforeImgUpload&&o.options.onBeforeImgUpload.call(o),o.showLoader(),o.imgUploadControl.hide(),o.options.processInline)if("undefined"==typeof FileReader)o.options.onError&&o.options.onError.call(o,"processInline is not supported by your Browser"),o.reset();else{var i=new FileReader;i.onload=function(t){var i=new Image;i.src=t.target.result,i.onload=function(){o.imgInitW=o.imgW=i.width,o.imgInitH=o.imgH=i.height,o.options.modal&&o.createModal(),$c.isEmptyObject(o.croppedImg)||o.croppedImg.remove(),o.imgUrl=i.src,o.obj.append('<img src="'+i.src+'">'),o.initCropper(),o.hideLoader(),o.options.onAfterImgUpload&&o.options.onAfterImgUpload.call(o)}},i.readAsDataURL(o.form.find('input[type="file"]')[0].files[0])}else{try{formData=new FormData(o.form[0])}catch(t){formData=new FormData,formData.append("img",o.form.find("input[type=file]")[0].files[0])}for(var e in o.options.uploadData)o.options.uploadData.hasOwnProperty(e)&&formData.append(e,o.options.uploadData[e]);$c.ajax({url:o.options.uploadUrl,data:formData,context:t.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always((function(t){o.afterUpload(t)}))}}))},loadExistingImage:function(){var o=this;if($c.isEmptyObject(o.croppedImg)){o.options.onBeforeImgUpload&&o.options.onBeforeImgUpload.call(o),o.showLoader(),o.options.modal&&o.createModal(),$c.isEmptyObject(o.croppedImg)||o.croppedImg.remove(),o.imgUrl=o.options.loadPicture;var t=$c('<img src="'+o.options.loadPicture+'">');o.obj.append(t),t.load((function(){o.imgInitW=o.imgW=this.width,o.imgInitH=o.imgH=this.height,o.initCropper(),o.hideLoader(),o.options.onAfterImgUpload&&o.options.onAfterImgUpload.call(o)}))}else o.cropControlRemoveCroppedImage.on("click",(function(){o.croppedImg.remove(),$c(this).hide(),$c.isEmptyObject(o.defaultImg)||o.obj.append(o.defaultImg),""!==o.options.outputUrlId&&$c("#"+o.options.outputUrlId).val(""),o.croppedImg="",o.reset()}))},afterUpload:function(o){var t=this;if(response="object"==typeof o?o:jQuery.parseJSON(o),"success"==response.status){t.imgInitW=t.imgW=response.width,t.imgInitH=t.imgH=response.height,t.options.modal&&t.createModal(),$c.isEmptyObject(t.croppedImg)||t.croppedImg.remove(),t.imgUrl=response.url;var i=$c('<img src="'+response.url+'">');t.obj.append(i),i.load((function(){t.initCropper(),t.hideLoader(),t.options.onAfterImgUpload&&t.options.onAfterImgUpload.call(t)})),t.options.onAfterImgUpload&&t.options.onAfterImgUpload.call(t)}"error"==response.status&&(alert(response.message),t.options.onError&&t.options.onError.call(t,response.message),t.hideLoader(),setTimeout((function(){t.reset()}),2e3))},createModal:function(){var o=this.windowH/2-this.objH/2,t='<div id="croppicModal"><div id="croppicModalObj" style="width:'+this.objW+"px; height:"+this.objH+"px; margin:0 auto; margin-top:"+o+'px; position: relative;"> </div></div>';$c("body").append(t),this.modal=$c("#croppicModal"),this.obj=$c("#croppicModalObj")},destroyModal:function(){this.obj=this.outputDiv,this.modal.remove(),this.modal={}},initCropper:function(){this.img=this.obj.find("img"),this.img.wrap('<div class="cropImgWrapper" style="overflow:hidden; z-index:1; position:absolute; width:'+this.objW+"px; height:"+this.objH+'px;"></div>'),this.createCropControls(),this.options.imgEyecandy&&this.createEyecandy(),this.initDrag(),this.initialScaleImg()},createEyecandy:function(){this.imgEyecandy=this.img.clone(),this.imgEyecandy.css({"z-index":"0",opacity:this.options.imgEyecandyOpacity}).appendTo(this.obj)},destroyEyecandy:function(){this.imgEyecandy.remove()},initialScaleImg:function(){var o=this;o.zoom(-o.imgInitW),o.zoom(40),o.options.enableMousescroll&&o.img.on("mousewheel",(function(t){t.preventDefault(),o.zoom(o.options.zoomFactor*t.deltaY)})),o.img.css({left:-(o.imgW-o.objW)/2,top:-(o.imgH-o.objH)/2,position:"relative"}),o.options.imgEyecandy&&o.imgEyecandy.css({left:-(o.imgW-o.objW)/2,top:-(o.imgH-o.objH)/2,position:"relative"})},createCropControls:function(){var o,t=this,i="",e="",n="",r="";t.options.doubleZoomControls&&(i='<i class="cropControlZoomMuchIn"></i>',e='<i class="cropControlZoomMuchOut"></i>'),t.options.rotateControls&&(n='<i class="cropControlRotateLeft"></i>',r='<i class="cropControlRotateRight"></i>'),o='<div class="cropControls cropControlsCrop">'+i+'<i class="cropControlZoomIn"></i><i class="cropControlZoomOut"></i>'+e+n+r+'<i class="cropControlCrop"></i><i class="cropControlReset"></i></div>',t.obj.append(o),t.cropControlsCrop=t.obj.find(".cropControlsCrop"),t.options.doubleZoomControls&&(t.cropControlZoomMuchIn=t.cropControlsCrop.find(".cropControlZoomMuchIn"),t.cropControlZoomMuchIn.on("click",(function(){t.zoom(10*t.options.zoomFactor)})),t.cropControlZoomMuchOut=t.cropControlsCrop.find(".cropControlZoomMuchOut"),t.cropControlZoomMuchOut.on("click",(function(){t.zoom(10*-t.options.zoomFactor)}))),t.cropControlZoomIn=t.cropControlsCrop.find(".cropControlZoomIn"),t.cropControlZoomIn.on("click",(function(){t.zoom(t.options.zoomFactor)})),t.cropControlZoomOut=t.cropControlsCrop.find(".cropControlZoomOut"),t.cropControlZoomOut.on("click",(function(){t.zoom(-t.options.zoomFactor)})),t.cropControlZoomIn=t.cropControlsCrop.find(".cropControlRotateLeft"),t.cropControlZoomIn.on("click",(function(){t.rotate(-t.options.rotateFactor)})),t.cropControlZoomOut=t.cropControlsCrop.find(".cropControlRotateRight"),t.cropControlZoomOut.on("click",(function(){t.rotate(t.options.rotateFactor)})),t.cropControlCrop=t.cropControlsCrop.find(".cropControlCrop"),t.cropControlCrop.on("click",(function(){t.crop()})),t.cropControlReset=t.cropControlsCrop.find(".cropControlReset"),t.cropControlReset.on("click",(function(){t.reset()}))},initDrag:function(){var t=this;t.img.on("mousedown touchstart",(function(i){var e,n;i.preventDefault();var r=o.navigator.userAgent;r.match(/iPad/i)||r.match(/iPhone/i)||r.match(/android/i)||null==(i.pageY&&i.pageX)?(e=i.originalEvent.touches[0].pageX,n=i.originalEvent.touches[0].pageY):(e=i.pageX,n=i.pageY);var s=t.img.css("z-index"),a=t.img.outerHeight(),p=t.img.outerWidth(),c=t.img.offset().top+a-n,l=t.img.offset().left+p-e;t.img.css("z-index",1e3).on("mousemove touchmove",(function(o){var i,e;if(r.match(/iPad/i)||r.match(/iPhone/i)||r.match(/android/i)||null==(o.pageY&&o.pageX)?(i=o.originalEvent.touches[0].pageY+c-a,e=o.originalEvent.touches[0].pageX+l-p):(i=o.pageY+c-a,e=o.pageX+l-p),t.img.offset({top:i,left:e}).on("mouseup",(function(){$c(this).removeClass("draggable").css("z-index",s)})),t.options.imgEyecandy&&t.imgEyecandy.offset({top:i,left:e}),t.objH<t.imgH){parseInt(t.img.css("top"))>0&&(t.img.css("top",0),t.options.imgEyecandy&&t.imgEyecandy.css("top",0));var n=-(t.imgH-t.objH);parseInt(t.img.css("top"))<n&&(t.img.css("top",n),t.options.imgEyecandy&&t.imgEyecandy.css("top",n))}else{parseInt(t.img.css("top"))<0&&(t.img.css("top",0),t.options.imgEyecandy&&t.imgEyecandy.css("top",0));n=t.objH-t.imgH;parseInt(t.img.css("top"))>n&&(t.img.css("top",n),t.options.imgEyecandy&&t.imgEyecandy.css("top",n))}if(t.objW<t.imgW){parseInt(t.img.css("left"))>0&&(t.img.css("left",0),t.options.imgEyecandy&&t.imgEyecandy.css("left",0));var m=-(t.imgW-t.objW);parseInt(t.img.css("left"))<m&&(t.img.css("left",m),t.options.imgEyecandy&&t.imgEyecandy.css("left",m))}else{parseInt(t.img.css("left"))<0&&(t.img.css("left",0),t.options.imgEyecandy&&t.imgEyecandy.css("left",0));m=t.objW-t.imgW;parseInt(t.img.css("left"))>m&&(t.img.css("left",m),t.options.imgEyecandy&&t.imgEyecandy.css("left",m))}t.options.onImgDrag&&t.options.onImgDrag.call(t)}))})).on("mouseup",(function(){t.img.off("mousemove")})).on("mouseout",(function(){t.img.off("mousemove")}))},rotate:function(o){this.actualRotation+=o,this.img.css({"-webkit-transform":"rotate("+this.actualRotation+"deg)","-moz-transform":"rotate("+this.actualRotation+"deg)",transform:"rotate("+this.actualRotation+"deg)"}),this.options.imgEyecandy&&this.imgEyecandy.css({"-webkit-transform":"rotate("+this.actualRotation+"deg)","-moz-transform":"rotate("+this.actualRotation+"deg)",transform:"rotate("+this.actualRotation+"deg)"}),"function"==typeof this.options.onImgRotate&&this.options.onImgRotate.call(this)},zoom:function(o){var t=this.imgW/this.imgH,i=this.imgW+o,e=i/t,n=!0;(i<this.objW||e<this.objH)&&(i-this.objW<e-this.objH?e=(i=this.objW)/t:i=t*(e=this.objH),n=!1),!this.options.scaleToFill&&(i>this.imgInitW||e>this.imgInitH)&&(i-this.imgInitW<e-this.imgInitH?e=(i=this.imgInitW)/t:i=t*(e=this.imgInitH),n=!1),this.imgW=i,this.img.width(i),this.imgH=e,this.img.height(e);var r=parseInt(this.img.css("top"))-o/2,s=parseInt(this.img.css("left"))-o/2;r>0&&(r=0),s>0&&(s=0);var a=-(e-this.objH);r<a&&(r=a);var p=-(i-this.objW);s<p&&(s=p),n&&this.img.css({top:r,left:s}),this.options.imgEyecandy&&(this.imgEyecandy.width(i),this.imgEyecandy.height(e),n&&this.imgEyecandy.css({top:r,left:s})),this.options.onImgZoom&&this.options.onImgZoom.call(this)},crop:function(){var o=this;o.options.onBeforeImgCrop&&o.options.onBeforeImgCrop.call(o),o.cropControlsCrop.hide(),o.showLoader();var i,e={imgUrl:o.imgUrl,imgInitW:o.imgInitW,imgInitH:o.imgInitH,imgW:o.imgW,imgH:o.imgH,imgY1:Math.abs(parseInt(o.img.css("top"))),imgX1:Math.abs(parseInt(o.img.css("left"))),cropH:o.objH,cropW:o.objW,rotation:o.actualRotation};if("undefined"==typeof FormData){var n,r=new XMLHttpRequest,s=[];for(var a in e)s.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));for(var a in o.options.cropData)s.push(encodeURIComponent(a)+"="+encodeURIComponent(o.options.cropData[a]));n=s.join("&").replace(/%20/g,"+"),r.addEventListener("error",(function(t){o.options.onError&&o.options.onError.call(o,"XHR Request failed")})),r.onreadystatechange=function(){4==r.readyState&&200==r.status&&o.afterCrop(r.responseText)},r.open("POST",o.options.cropUrl),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("Content-Length",n.length),r.send(n)}else{for(var a in i=new FormData,e)e.hasOwnProperty(a)&&i.append(a,e[a]);for(var a in o.options.cropData)o.options.cropData.hasOwnProperty(a)&&i.append(a,o.options.cropData[a]);$c.ajax({url:o.options.cropUrl,data:i,context:t.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always((function(t){o.afterCrop(t)}))}},afterCrop:function(o){var t=this;try{response=jQuery.parseJSON(o)}catch(t){response="object"==typeof o?o:jQuery.parseJSON(o)}"success"==response.status&&(t.options.imgEyecandy&&t.imgEyecandy.hide(),t.destroy(),t.obj.append('<img class="croppedImg" src="'+response.url+'">'),""!==t.options.outputUrlId&&$c("#"+t.options.outputUrlId).val(response.url),t.croppedImg=t.obj.find(".croppedImg"),t.init(),t.hideLoader()),"error"==response.status&&(t.options.onError&&t.options.onError.call(t,response.message),t.hideLoader(),setTimeout((function(){t.reset()}),2e3)),t.options.onAfterImgCrop&&t.options.onAfterImgCrop.call(t,response)},showLoader:function(){this.obj.append(this.options.loaderHtml),this.loader=this.obj.find(".loader")},hideLoader:function(){this.loader.remove()},reset:function(){this.destroy(),this.init(),$c.isEmptyObject(this.croppedImg)||(this.obj.append(this.croppedImg),""!==this.options.outputUrlId&&$c("#"+this.options.outputUrlId).val(this.croppedImg.attr("url"))),"function"==typeof this.options.onReset&&this.options.onReset.call(this)},destroy:function(){this.options.modal&&!$c.isEmptyObject(this.modal)&&this.destroyModal(),this.options.imgEyecandy&&!$c.isEmptyObject(this.imgEyecandy)&&this.destroyEyecandy(),$c.isEmptyObject(this.cropControlsUpload)||this.cropControlsUpload.remove(),$c.isEmptyObject(this.cropControlsCrop)||this.cropControlsCrop.remove(),$c.isEmptyObject(this.loader)||this.loader.remove(),$c.isEmptyObject(this.form)||this.form.remove(),this.obj.html("")},isAjaxUploadSupported:function(){var o=t.createElement("input");return o.type="file","multiple"in o&&"undefined"!=typeof File&&"undefined"!=typeof FormData&&void 0!==(new XMLHttpRequest).upload},CreateFallbackIframe:function(){var o=this;if(o.isAjaxUploadSupported())return"";if(jQuery.isEmptyObject(o.iframeobj)){var i=t.createElement("iframe");i.setAttribute("id",o.id+"_upload_iframe"),i.setAttribute("name",o.id+"_upload_iframe"),i.setAttribute("width","0"),i.setAttribute("height","0"),i.setAttribute("border","0"),i.setAttribute("src","javascript:false;"),i.style.display="none",t.body.appendChild(i)}else i=o.iframeobj[0];var e='<!DOCTYPE html><html><head><title>Uploading File</title></head><body><form class="'+o.id+'_upload_iframe_form" name="'+o.id+'_upload_iframe_form" action="'+o.options.uploadUrl+'" method="post" enctype="multipart/form-data" encoding="multipart/form-data" style="display:none;">'+$c("#"+o.id+"_imgUploadField")[0].outerHTML+"</form></body></html>";i.contentWindow.document.open("text/htmlreplace"),i.contentWindow.document.write(e),i.contentWindow.document.close(),o.iframeobj=$c("#"+o.id+"_upload_iframe"),o.iframeform=o.iframeobj.contents().find("html").find("."+o.id+"_upload_iframe_form"),o.iframeform.on("change","input",(function(){o.SubmitFallbackIframe(o)})),o.iframeform.find("input")[0].attachEvent("onchange",(function(){o.SubmitFallbackIframe(o)}));var n=function(){i.detachEvent?i.detachEvent("onload",n):i.removeEventListener("load",n,!1);var t=o.getIframeContentJSON(i);jQuery.isEmptyObject(o.modal)&&o.afterUpload(t)};return i.addEventListener&&i.addEventListener("load",n,!0),i.attachEvent&&i.attachEvent("onload",n),"#"+o.id+"_imgUploadField"},SubmitFallbackIframe:function(o){o.showLoader(),o.options.processInline&&!o.options.uploadUrl?o.options.onError&&(o.options.onError.call(o,"processInline is not supported by your browser "),o.hideLoader()):(o.options.onBeforeImgUpload&&o.options.onBeforeImgUpload.call(o),o.iframeform[0].submit())},getIframeContentJSON:function(o){try{var t,i=o.contentDocument?o.contentDocument:o.contentWindow.document,e=i.body.innerHTML;"<pre>"==e.slice(0,5).toLowerCase()&&"</pre>"==e.slice(-6).toLowerCase()&&(e=i.body.firstChild.firstChild.nodeValue),t=jQuery.parseJSON(e)}catch(o){t={success:!1}}return t}}}(window,document);
